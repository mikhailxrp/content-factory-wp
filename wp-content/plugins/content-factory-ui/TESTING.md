# Инструкция по тестированию функционала "Генерация из редактора"

## Что было реализовано

Добавлен функционал генерации статей прямо из редактора WordPress (Gutenberg) с помощью N8N.

## Новые файлы

### Backend (PHP):

- `src/Rest/Controllers/PostEditorController.php` - контроллер для генерации из редактора
- `src/Support/EditorAssets.php` - подключение assets в редактор
- Обновлены: `src/N8n/Endpoints.php`, `src/Rest/Router.php`, `src/WP/PostPublisher.php`, `src/Plugin.php`

### Frontend (JavaScript):

- `assets/editor/generate-button.js` - React компонент с кнопкой и модалкой
- `assets/editor/editor.css` - стили для модалки

### Документация:

- `README.md` - добавлена полная документация по новому функционалу

## Как протестировать

### 1. Подготовка N8N

Создайте два webhook в N8N:

**Webhook 1: Генерация статьи**

- URL: `/webhook/generate-article-from-editor`
- Метод: POST
- Принимает: `{ post_id, role, prompt, sections }`
- Возвращает: `{ "status": "started", "job_id": "xxx", "post_id": 123 }`

**Webhook 2: Проверка статуса**

- URL: `/webhook/check-editor-article-status`
- Метод: GET
- Query параметры: `post_id`, `job_id` (опционально)
- Возвращает:
  - В процессе: `{ "status": "processing", "post_id": 123 }`
  - Готово: `{ "status": "completed", "post_id": 123, "content": "<h2>...</h2>", "title": "..." }`
  - Ошибка: `{ "status": "error", "post_id": 123, "error_message": "..." }`

### 2. Проверка в WordPress

1. **Откройте редактор поста:**
   - Создайте новый пост или откройте существующий
   - В правом сайдбаре должна появиться панель **"Content Factory"**

2. **Проверьте кнопку:**
   - Нажмите на кнопку **"Сгенерировать статью"**
   - Должно открыться модальное окно с формой

3. **Заполните форму:**
   - Роль: `SEO эксперт по недвижимости`
   - Промпт: `Напиши статью про ипотеку для молодых семей`
   - Секции: `Введение\nУсловия ипотеки\nДокументы\nПреимущества\nЗаключение`

4. **Запустите генерацию:**
   - Нажмите кнопку **"Сгенерировать"**
   - Должно появиться уведомление "Генерация статьи запущена"
   - Кнопка должна стать неактивной с текстом "Генерация..."

5. **Дождитесь результата:**
   - Плагин автоматически проверяет статус каждые 10 секунд
   - Когда статья готова, контент автоматически появится в редакторе
   - Модальное окно закроется
   - Появится уведомление "Статья успешно сгенерирована!"

### 3. Проверка REST API

Можно протестировать endpoints напрямую через Postman:

**Запуск генерации:**

```
POST /wp-json/content-factory/v1/posts/123/generate-article
Headers:
  X-WP-Nonce: <nonce>
Body:
{
  "role": "SEO эксперт",
  "prompt": "Напиши статью про...",
  "sections": "Введение\nОсновная часть\nЗаключение"
}
```

**Проверка статуса:**

```
GET /wp-json/content-factory/v1/posts/123/check-article-status
Headers:
  X-WP-Nonce: <nonce>
```

### 4. Проверка логов

Откройте `wp-content/debug.log` и проверьте логи:

```
[PostEditorController] Генерация статьи для поста ID: 123
[PostEditorController] Endpoint: /webhook/generate-article-from-editor
[PostEditorController] Данные: {"role":"...","prompt":"...","sections":"..."}
[PostEditorController] Генерация запущена успешно: {"status":"started",...}
[PostEditorController] Проверка статуса генерации для поста ID: 123
[PostEditorController] Статус получен: {"status":"completed",...}
[PostPublisher] Пост ID 123 успешно обновлен
```

## Возможные проблемы

### Кнопка не появляется в редакторе

**Причина:** Assets не подключаются

**Решение:**

1. Проверьте, что файлы существуют:
   - `assets/editor/generate-button.js`
   - `assets/editor/editor.css`
2. Очистите кэш браузера (Ctrl+F5)
3. Проверьте консоль браузера на ошибки JavaScript

### Ошибка "Endpoint не настроен"

**Причина:** N8N URL не настроен или endpoint не существует

**Решение:**

1. Перейдите в "Content Factory → Настройки"
2. Убедитесь, что указан корректный URL N8N
3. Нажмите "Проверить подключение"
4. Проверьте, что webhooks созданы в N8N

### Генерация не запускается

**Причина:** Ошибка валидации или права доступа

**Решение:**

1. Проверьте, что все поля заполнены
2. Убедитесь, что у пользователя есть права `edit_post`
3. Проверьте логи WordPress (`wp-content/debug.log`)

### Контент не обновляется автоматически

**Причина:** N8N не возвращает статус "completed" или неправильный формат ответа

**Решение:**

1. Проверьте формат ответа от N8N (должен содержать `status` и `content`)
2. Проверьте логи: `[PostEditorController] Статус получен: ...`
3. Убедитесь, что N8N возвращает HTML в поле `content`

## Контракт данных для N8N (краткая справка)

### POST /webhook/generate-article-from-editor

```json
// Запрос
{
  "post_id": 123,
  "role": "SEO эксперт",
  "prompt": "текст",
  "sections": "Секция 1\nСекция 2"
}

// Ответ
{
  "status": "started",
  "job_id": "uuid",
  "post_id": 123
}
```

### GET /webhook/check-editor-article-status?post_id=123

```json
// Ответ (готово)
{
  "status": "completed",
  "post_id": 123,
  "content": "<h2>Заголовок</h2><p>Текст...</p>",
  "title": "Новый заголовок" // опционально
}
```

## Что дальше?

После успешного тестирования можно:

1. Настроить реальную генерацию через AI в N8N
2. Добавить дополнительные поля в форму (если нужно)
3. Настроить кастомные промпты для разных типов контента
4. Интегрировать с существующей системой промптов плагина

## Поддержка

При возникновении проблем:

1. Проверьте логи WordPress (`wp-content/debug.log`)
2. Проверьте консоль браузера (F12 → Console)
3. Проверьте Network tab в DevTools для REST API запросов
4. Убедитесь, что N8N webhooks работают корректно
